{"version":3,"sources":["web-track-mini.cjs.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\n/**\r\n * 获取跨平台的 SDK\r\n */\r\nconst getSDK = () => {\r\n    let currentSdk = {\r\n        // tslint:disable-next-line: no-empty\r\n        request: () => { },\r\n        // tslint:disable-next-line: no-empty\r\n        httpRequest: () => { },\r\n        // tslint:disable-next-line: no-empty\r\n        getSystemInfoSync: () => { },\r\n    };\r\n    if (typeof wx === 'object') {\r\n        // tslint:disable-next-line: no-unsafe-any\r\n        currentSdk = wx;\r\n    }\r\n    else if (typeof dd === 'object') {\r\n        // dd 必须出现在 my之前，因为现在dd环境里也有my\r\n        // tslint:disable-next-line: no-unsafe-any\r\n        currentSdk = dd;\r\n    }\r\n    else if (typeof my === 'object') {\r\n        // tslint:disable-next-line: no-unsafe-any\r\n        currentSdk = my;\r\n    }\r\n    else if (typeof tt === 'object') {\r\n        // tslint:disable-next-line: no-unsafe-any\r\n        currentSdk = tt;\r\n    }\r\n    else if (typeof qq === 'object') {\r\n        // tslint:disable-next-line: no-unsafe-any\r\n        currentSdk = qq;\r\n    }\r\n    else if (typeof swan === 'object') {\r\n        // tslint:disable-next-line: no-unsafe-any\r\n        currentSdk = swan;\r\n    }\r\n    else {\r\n        throw new Error('Current platform is not supported by SLS web track, Pleace contack Aliyun SLS team.');\r\n    }\r\n    return currentSdk;\r\n};\r\n/**\r\n * 获取平台名称\r\n */\r\nconst getAppName = () => {\r\n    let currentAppName = 'unknown';\r\n    if (typeof wx === 'object') {\r\n        currentAppName = 'wechat';\r\n    }\r\n    else if (typeof dd === 'object') {\r\n        // dd 必须出现在 my之前，因为现在dd环境里也有my\r\n        currentAppName = 'dingtalk';\r\n    }\r\n    else if (typeof my === 'object') {\r\n        currentAppName = 'alipay';\r\n    }\r\n    else if (typeof tt === 'object') {\r\n        currentAppName = 'bytedance';\r\n    }\r\n    else if (typeof qq === 'object') {\r\n        currentAppName = 'qq';\r\n    }\r\n    else if (typeof swan === 'object') {\r\n        currentAppName = 'swan';\r\n    }\r\n    return currentAppName;\r\n};\r\nconst sdk = getSDK();\r\nconst appName = getAppName();\n\nclass WebTracker {\r\n    constructor(opt) {\r\n        var _a, _b;\r\n        this.timer = null;\r\n        this.time = 10;\r\n        this.count = 10;\r\n        this.arr = [];\r\n        this.time = (_a = opt.time) !== null && _a !== void 0 ? _a : 10; //定义时间，number类型\r\n        this.count = (_b = opt.count) !== null && _b !== void 0 ? _b : 10; //定义数据条数，number类型\r\n        this.url = 'https://' + opt.project + '.' + opt.host + '/logstores/' + opt.logstore + '/track';\r\n        this.opt = opt;\r\n        if (opt.installUnloadHook && typeof opt.installUnloadHook === 'function') {\r\n            opt.installUnloadHook(() => {\r\n                this.platformSend(this.assemblePayload());\r\n            });\r\n        }\r\n    }\r\n    assemblePayload(arr = this.arr) {\r\n        const payload = {\r\n            __logs__: arr,\r\n        };\r\n        if (this.opt.tags) {\r\n            payload.__tags__ = this.opt.tags;\r\n        }\r\n        if (this.opt.topic) {\r\n            payload.__topic__ = this.opt.topic;\r\n        }\r\n        if (this.opt.source) {\r\n            payload.__source__ = this.opt.source;\r\n        }\r\n        return JSON.stringify(payload);\r\n    }\r\n    platformSend(payloadStr) {\r\n        if (this.opt.sendPayload && typeof this.opt.sendPayload === 'function') {\r\n            this.opt.sendPayload(this.url, payloadStr);\r\n        }\r\n    }\r\n    transString(obj) {\r\n        let newObj = {};\r\n        for (let i in obj) {\r\n            if (typeof obj[i] == 'object') {\r\n                newObj[i] = JSON.stringify(obj[i]);\r\n            }\r\n            else {\r\n                newObj[i] = String(obj[i]);\r\n            }\r\n        }\r\n        return newObj;\r\n    }\r\n    sendImmediateInner() {\r\n        if (this.arr && this.arr.length > 0) {\r\n            this.platformSend(this.assemblePayload());\r\n            if (this.timer != null) {\r\n                clearTimeout(this.timer);\r\n                this.timer = null;\r\n            }\r\n            this.arr = [];\r\n        }\r\n    }\r\n    sendInner() {\r\n        if (this.timer) {\r\n            if (this.arr.length >= this.count) {\r\n                clearTimeout(this.timer);\r\n                this.timer = null;\r\n                this.sendImmediateInner();\r\n            }\r\n        }\r\n        else {\r\n            const that = this;\r\n            if (this.arr.length >= this.count || this.time <= 0) {\r\n                this.sendImmediateInner();\r\n            }\r\n            else {\r\n                this.timer = setTimeout(function () {\r\n                    that.sendImmediateInner();\r\n                }, this.time * 1000);\r\n            }\r\n        }\r\n    }\r\n    send(originLog) {\r\n        const obj = this.transString(originLog);\r\n        this.arr.push(obj);\r\n        this.sendInner();\r\n    }\r\n    sendImmediate(originLog) {\r\n        const obj = this.transString(originLog);\r\n        this.arr.push(obj);\r\n        this.sendImmediateInner();\r\n    }\r\n    sendBatchLogs(originLogs) {\r\n        const logs = originLogs.map((originLog) => this.transString(originLog));\r\n        this.arr.push(...logs);\r\n        this.sendInner();\r\n    }\r\n    sendBatchLogsImmediate(originLogs) {\r\n        const logs = originLogs.map((originLog) => this.transString(originLog));\r\n        this.arr.push(...logs);\r\n        this.sendImmediateInner();\r\n    }\r\n}\n\nfunction send(url, payload) {\r\n    const request = sdk.request || sdk.httpRequest;\r\n    request({\r\n        url: `${url}?APIVersion=0.6.0`,\r\n        method: 'POST',\r\n        data: payload,\r\n    });\r\n}\r\nclass WebTrackerMini extends WebTracker {\r\n    constructor(opt) {\r\n        const superOpt = Object.assign({}, opt, {\r\n            sendPayload: (url, payload) => {\r\n                send(url, payload);\r\n            },\r\n        });\r\n        super(superOpt);\r\n    }\r\n}\n\nfunction defineGlobal(global, name, api) {\r\n    global[name] = api;\r\n}\r\ndefineGlobal(sdk, 'SLS_Tracker', WebTrackerMini);\n\nexports.appName = appName;\nexports[\"default\"] = WebTrackerMini;\nexports.defineGlobal = defineGlobal;\n//# sourceMappingURL=web-track-mini.cjs.js.map\n"]}